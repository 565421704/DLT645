# DL/T 645 采集软件包使用说明

本软件包用于 DL/T 645 协议的采集与数据处理。在硬件层的移植（主要针对于串口收发数据）完成之后， **用户仅需调用一个API即可完成针对于特定协议（DL/T 1997 或 DL/T 2007）的标识符数据读取、处理与存储。** 使用户无需关注请求数据的封包与接收数据的解包等复杂的协议内部操作，真正做到 **一键采集** 。

当然，由于本人精力有限，无法第一时间考虑并编写所有可能的情况与功能，所以在软件包的初期其功能只是根据我所用到的功能进行编写，无法涵盖所有的需求。并且可能会有一些小问题。但本文档今后会加入详细的功能开发指南，供开发成员们能够很方便地根据自己的需求进行功能的添加与修改。随着时间的推移，本软件包会逐步趋向于完善，也希望使用本软件包的开发人员们能够加入到软件包的完善中来，为该软件包的成长提供一份宝贵的力量！

### 目前支持的功能：

1. DL/T 645 1997 版数据采集与部分标识符数据解析
2. DL/T 645 2007 版数据采集与部分标识符数据解析
- 标识符的解析提供了便捷的接口，用户可以调用该接口实现自己所需标识符的解析功能
- 目前还不支持数据写入功能


## 一、软件包使用说明

在使用软件包之前， 需要把 **src** 目录下的所有源文件加入工程，将 **inc** 添加到头文件目录，并且参照 **port** 路径下的 **dlt645_port.c** 源文件实现基于用户使用的硬件平台的底层硬件操作的移植。（详细的移植方法会在下文进行描述）

当完成硬件接口移植后，可以参照以下步骤进行对软件包的使用：

1. 调用用户实现的硬件接口初始化用于DLT645采集的硬件，并注册645环境结构体。
2. 调用 `dlt645_set_addr()` 函数设置需要采集的从机设备地址。（函数详细说明请阅读 **API详解** ）
3. 调用 `dlt645_read_data()` 函数进行具体标识符数据的读取并存储到用户指定的地址下。（函数详细说明请阅读 **API详解** ）


## 二、软件包移植指南

###### 待完善

## 三、API详解

### 1、设置从机地址

**简介：** 用户在通过645协议读取某设备的数据时，首先要通过该接口设置想要读取的从机的地址。

**API格式：** 

```C
 void dlt645_set_addr(dlt645_t *ctx, uint8_t *addr);
```

**参数：**

|参数名|介绍|
|-|--------|
|ctx|645结构句柄|
|addr|6位地址数组|

**使用示例**

```C

//dlt645 环境结构体
extern dlt645_t dlt645;
//从机地址为111
uint8_t slave_addr[6] = {0x00,0x00,0x00,0x00,0x01,0x11};

dlt645_set_addr(&dlt645,slave_addr);

```

### 2、读取数据

**简介：** 用户通过调用该接口读取从机指定标识符的数据

**API格式：** 

```C
int dlt645_read_data(dlt645_t *ctx, uint32_t code, uint8_t *read_data, dlt645_protocal protocal);
```

**参数：**

|参数名|描述|
|-|--------|
|ctx|645结构句柄|
|code|标识符|
|read_data|读取数据的存储地址（注意地址长度为4字节）|
|protocal|指定协议类型（可选 **DLT645_2007** 或 **DLT645_1997** ）|

|返回值|描述|
|-|--------|
|整数|读取数据长度|
|-1|读取失败|

- **read_data** 参数为读取数据的存储地址，目前的版本中将所有的数据都转换为浮点数保存，因此 **read_data** 大小必须为4字节。

- **protocal** 参数指定了读取的协议类型，可选值为：`DLT645_1997` 和 `DLT645_2007` ，分别对应1997版与2007版。

**使用示例**

```C

//dlt645 环境结构体
extern dlt645_t dlt645;
//dlt645 采集测试标识符 （A相电压）
#define DLT645_2007_READ_TEST_CODE 0x02010100
//用于存放读取数据的数组
uint8_t read_buf[4];

//读取数据
if (dlt645_read_data(&dlt645,DLT645_2007_READ_TEST_CODE,read_buf,DLT645_2007) > 0)  
{
    printf("读取成功,A相电压值为: %.2f \r\n",*(float *)read_buf);
}
else
{
    rt_kprintf("读取失败\r\n");
}

```


